# Latest Ubuntu LTS as of 03/13/2025
FROM ubuntu:24.04

# Arguments (with defaults)
ARG GIT_REPO="https://github.com/odoo/odoo.git"
ARG COMMIT_ID="b394204"

# Environment variables
ENV ODOO_PATH="/odoo"
ENV GIT_REPO=${GIT_REPO}
ENV COMMIT_ID=${COMMIT_ID}

# Install dependencies
RUN apt update && apt upgrade -y
RUN apt install -y   \
	git                \
	python3            \
	python3-pip        \
	postgresql         \
	postgresql-client

# Create user
# RUN useradd -M -s /bin/false odoo   <- NO SHELL
RUN adduser -D -s /bin/bash odoo

# Create directory for odoo and delegate ownership
RUN mkdir -p $ODOO_PATH

# Build the dependencies - check for cached dependencies first
RUN git clone $GIT_REPO $ODOO_PATH

# Install odoo and delegate ownership
RUN $ODOO_PATH/setup/debinstall.sh
RUN chown odoo:odoo $ODOO_PATH

# Expose volume for configuration file and addons
VOLUME ["$ODOO_PATH/odoo.conf", "$ODOO_PATH/addons"]

# Expose port
EXPOSE 8069

# Set root password using command line secret
RUN --mount=type=secret,id=root_password \
	ROOT_PASSWORD=$(cat /run/secrets/root_password) && \
	echo "root:$ROOT_PASSWORD" | chpasswd

# Run & make explicit declaration of context
USER odoo
WORKDIR $ODOO_PATH
ENTRYPOINT ["python3", "odoo-bin", "--addons-path=addons", "-d" , "odoo"]

